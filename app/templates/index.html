{% extends "base.html" %}
{% block content %}

<div class="card">
  <h2>Create New Workspace</h2>
  <form action="/create" method="post" class="row" style="flex-wrap:wrap;">
    <input type="text" name="name" placeholder="Project Name (e.g. sm8750)" required>
    <button type="submit">Create</button>
    <div style="flex:1"></div>
    <input id="projectSearch" type="text" placeholder="Search projectsâ€¦" style="max-width:360px;">
  </form>
</div>

<div class="row" style="align-items:flex-end; gap:12px; margin-bottom:8px;">
  <h3 style="margin:0;">Existing Projects</h3>
  <div class="dim" id="projCount"></div>
</div>

{% if not projects %}
  <div class="dim" style="text-align:center; padding:40px;">No projects created yet.</div>
{% else %}

  <div id="pinnedWrap" class="card" style="display:none;">
    <div class="row" style="justify-content:space-between;">
      <h3 style="margin:0;">Pinned</h3>
      <div class="dim">Pinned projects are saved in your browser.</div>
    </div>
    <div id="pinnedList" style="margin-top:10px;"></div>
  </div>

  <div id="allWrap">
    {% for p in projects %}
      <div class="card row projectRow"
           data-name="{{ p.name|lower }}"
           data-project="{{ p.name }}"
           style="justify-content:space-between;">
        <div style="flex:1; min-width:260px;">
          <div class="row" style="gap:10px;">
            <div style="font-size:18px; font-weight:bold;">{{ p.name }}</div>
            <span class="status s-{{ p.status }}">{{ p.status }}</span>
            <span class="pill dim" style="font-size:12px;">
              {{ p.file_count }} dtsi
            </span>
          </div>
          <div class="dim" style="margin-top:6px; font-size:12px;">
            Last updated: {{ p.last_modified }}
          </div>
        </div>

        <div class="row">
          <button class="secondary pinBtn" type="button" data-project="{{ p.name }}">ðŸ“Œ Pin</button>
          <a href="/project/{{ p.name }}"><button>Open</button></a>
        </div>
      </div>
    {% endfor %}
  </div>

{% endif %}

<style>
  .pill {
    background: #0f172a;
    border: 1px solid #334155;
    border-radius: 999px;
    padding: 4px 10px;
  }
</style>

<script>
  const LS_KEY = "qgenie_pins_v1";

  function loadPins() {
    try { return JSON.parse(localStorage.getItem(LS_KEY) || "[]"); }
    catch(e) { return []; }
  }
  function savePins(pins) {
    localStorage.setItem(LS_KEY, JSON.stringify(pins));
  }

  function renderPins() {
    const pins = loadPins();
    const pinnedWrap = document.getElementById("pinnedWrap");
    const pinnedList = document.getElementById("pinnedList");
    const rows = Array.from(document.querySelectorAll(".projectRow"));

    // update pin button labels
    rows.forEach(r => {
      const name = r.dataset.project;
      const btn = r.querySelector(".pinBtn");
      if (!btn) return;
      btn.textContent = pins.includes(name) ? "âœ… Pinned" : "ðŸ“Œ Pin";
    });

    // build pinned section
    pinnedList.innerHTML = "";
    const pinnedRows = rows.filter(r => pins.includes(r.dataset.project));
    if (pinnedRows.length === 0) {
      pinnedWrap.style.display = "none";
      return;
    }
    pinnedWrap.style.display = "";

    pinnedRows.forEach(r => {
      const clone = r.cloneNode(true);
      // Make cloned pin button functional too
      const btn = clone.querySelector(".pinBtn");
      if (btn) {
        btn.addEventListener("click", () => togglePin(btn.dataset.project));
      }
      pinnedList.appendChild(clone);
    });
  }

  function togglePin(projectName) {
    const pins = loadPins();
    const idx = pins.indexOf(projectName);
    if (idx >= 0) pins.splice(idx, 1);
    else pins.push(projectName);
    savePins(pins);
    renderPins();
  }

  // wire buttons
  document.querySelectorAll(".pinBtn").forEach(btn => {
    btn.addEventListener("click", () => togglePin(btn.dataset.project));
  });

  // search projects
  const search = document.getElementById("projectSearch");
  search?.addEventListener("input", () => {
    const q = (search.value || "").trim().toLowerCase();
    let visible = 0;
    document.querySelectorAll(".projectRow").forEach(row => {
      const name = row.dataset.name || "";
      const show = name.includes(q);
      row.style.display = show ? "" : "none";
      if (show) visible++;
    });
    document.getElementById("projCount").textContent = `${visible} shown`;
  });

  // init count + pins
  const total = document.querySelectorAll(".projectRow").length;
  document.getElementById("projCount").textContent = `${total} total`;
  renderPins();
</script>

{% endblock %}
``