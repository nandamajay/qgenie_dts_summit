{% extends "base.html" %}
{% block content %}
<style>
.viz-container {
  height: 62vh;
  overflow: auto;
  background: #0b1220;
  border: 1px solid #334155;
  border-radius: 8px;
  padding: 12px;
}
.toolbar {
  display:flex; gap:10px; flex-wrap:wrap;
  align-items:center; justify-content:space-between;
  margin-bottom:10px;
}
.toolbar .left, .toolbar .right { display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
pre.src {
  background: #0f172a;
  border-radius: 8px;
  border: 1px solid #334155;
  overflow: auto;
  font-family: ui-monospace, SFMono-Regular, Menlo, monospace;
  color: #e2e8f0;
  padding: 0;
  max-height: 45vh;
}
.src-line { display:flex; gap:12px; padding: 2px 10px; white-space: pre; }
.src-line:hover { background: rgba(148,163,184,0.08); }
.ln { width: 60px; text-align: right; color: #94a3b8; user-select: none; }
.dim-small { color:#94a3b8; font-size:12px; }
.tabs { display:flex; gap:8px; align-items:center; }
.tabbtn {
  background: #111827;
  border: 1px solid #334155;
  color: #e2e8f0;
  padding: 6px 10px;
  border-radius: 999px;
  cursor: pointer;
  font-size: 13px;
}
.tabbtn.active { background: #2563eb; border-color: #3b82f6; }
</style>

<div class="row" style="margin-bottom:12px;">
  <a href="/project/{{ name }}"><button class="secondary">‚Üê Back to {{ name }}</button></a>
  <h2 style="margin:0;">Analysis: {{ filename }}</h2>
</div>

<div class="card">
  <div class="toolbar">
    <div class="left">
      <h3 style="margin:0;">Visualization</h3>
      <div class="tabs">
        <button id="tabOverview" class="tabbtn" onclick="renderView('overview')">Overview</button>
        <button id="tabIdle" class="tabbtn" onclick="renderView('idle')"
          {% if not has_idle %}disabled style="opacity:.5; cursor:not-allowed;"{% endif %}>
          Power & Idle
        </button>
      </div>
      <span class="dim-small" id="hintText">Overview shows major subsystems</span>
    </div>
    <div class="right">
      <button onclick="exportMermaid()">Export Mermaid</button>
      <button onclick="exportSVG()">Export SVG</button>
    </div>
  </div>

  <div class="viz-container">
    <div class="mermaid" id="mermaidBox">
      {{ overview_mermaid | safe }}
    </div>
  </div>
</div>

<div class="card">
  <h3>Source Code</h3>
  <div class="dim-small" style="margin-bottom:8px;">Source shown for reference.</div>
  <pre class="src" id="srcBox">{% for line in source_lines %}
<div class="src-line" id="L{{ loop.index }}"><span class="ln">{{ "%4d"|format(loop.index) }}</span><span>{{ line|e }}</span></div>{% endfor %}</pre>
</div>

<script>
  const OVERVIEW_MERMAID = `{{ overview_mermaid | replace('`','\\`') | safe }}`;
  const IDLE_MERMAID = `{{ idle_mermaid | default('') | replace('`','\\`') | safe }}`;
  const HAS_IDLE = {{ 'true' if has_idle else 'false' }};
  let CURRENT_VIEW = "overview";

  function mermaidReady() {
    return (window.mermaid && typeof window.mermaid.run === 'function');
  }

  function setMermaid(text) {
    const el = document.getElementById('mermaidBox');
    el.innerHTML = '';
    el.classList.add('mermaid');
    el.textContent = text;

    const tryRun = (attempt = 0) => {
      if (!mermaidReady()) {
        if (attempt < 80) return setTimeout(() => tryRun(attempt + 1), 50);
        return;
      }
      window.mermaid.run({ nodes: [el] });
    };
    tryRun();
  }

  function setTabActive(view) {
    document.getElementById('tabOverview')?.classList.toggle('active', view === 'overview');
    document.getElementById('tabIdle')?.classList.toggle('active', view === 'idle');
  }

  window.renderView = function(view) {
    if (view === 'idle' && !HAS_IDLE) return;
    CURRENT_VIEW = view;
    setTabActive(view);
    if (view === 'idle') {
      document.getElementById('hintText').textContent = 'Power/Idle diagram';
      setMermaid(IDLE_MERMAID);
    } else {
      document.getElementById('hintText').textContent = 'Overview shows major subsystems';
      setMermaid(OVERVIEW_MERMAID);
    }
  };

  window.exportMermaid = function() {
    const src = (CURRENT_VIEW === 'idle') ? IDLE_MERMAID : OVERVIEW_MERMAID;
    const blob = new Blob([src], {type: 'text/plain;charset=utf-8'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `{{ filename }}.${CURRENT_VIEW}.mmd`;
    a.click();
    URL.revokeObjectURL(a.href);
  };

  window.exportSVG = function() {
    const svg = document.querySelector('.viz-container svg');
    if (!svg) { alert('SVG not ready yet. Scroll the diagram once and try again.'); return; }
    const serializer = new XMLSerializer();
    let src = serializer.serializeToString(svg);
    if (!src.match(/^<svg[^>]+xmlns=\"http:\/\/www\.w3\.org\/2000\/svg\"/)) {
      src = src.replace('<svg', '<svg xmlns="http://www.w3.org/2000/svg">');
    }
    const blob = new Blob([src], {type: 'image/svg+xml;charset=utf-8'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `{{ filename }}.${CURRENT_VIEW}.svg`;
    a.click();
    URL.revokeObjectURL(a.href);
  };

  // initial render
  setTabActive(CURRENT_VIEW);
  renderView(CURRENT_VIEW);
</script>
{% endblock %}