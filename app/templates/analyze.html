{% extends "base.html" %}
{% block content %}
<style>
.viz-container {
  height: 62vh;
  overflow: auto;
  background: #0b1220;
  border: 1px solid #334155;
  border-radius: 8px;
  padding: 12px;
}
.toolbar {
  display:flex; gap:10px; flex-wrap:wrap;
  align-items:center; justify-content:space-between;
  margin-bottom:10px;
}
.toolbar .left, .toolbar .right { display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
input.search {
  width: 360px;
  max-width: 70vw;
}
pre.src {
  background: #0f172a;
  border-radius: 8px;
  border: 1px solid #334155;
  overflow: auto;
  font-family: ui-monospace, SFMono-Regular, Menlo, monospace;
  color: #e2e8f0;
  padding: 0;
  max-height: 45vh;
}
.src-line {
  display:flex;
  gap:12px;
  padding: 2px 10px;
  white-space: pre;
}
.src-line:hover { background: rgba(148,163,184,0.08); }
.ln {
  width: 60px;
  text-align: right;
  color: #94a3b8;
  user-select: none;
}
.src-line.hl {
  background: rgba(245, 158, 11, 0.18);
  border-left: 3px solid #f59e0b;
}
.dim-small { color:#94a3b8; font-size:12px; }
</style>

<div class="row" style="margin-bottom:12px;">
  <a href="/project/{{ name }}"><button class="secondary">← Back to {{ name }}</button></a>
  <h2 style="margin:0">Analysis: {{ filename }}</h2>
</div>

<div class="card">
  <div class="toolbar">
    <div class="left">
      <h3 style="margin:0">Device Tree Visualization</h3>
      <span class="dim-small">Search nodes • Click node to jump to source • Scroll to pan</span>
    </div>
    <div class="right">
      <input class="search" id="nodeSearch" placeholder="Search node name/label (e.g., sound, codec, pinctrl)"/>
      <button class="secondary" onclick="clearSearch()">Clear</button>
      <button onclick="exportMermaid()">Export Mermaid</button>
      <button onclick="exportSVG()">Export SVG</button>
    </div>
  </div>

  <div class="viz-container">
    <div class="mermaid" id="mermaidBox">{{ mermaid_code | safe }}</div>
  </div>
</div>

<div class="card">
  <h3>Source Code</h3>
  <div class="dim-small" style="margin-bottom:8px;">
    Click on any graph node to jump here and highlight the source block.
  </div>

  <pre class="src" id="srcBox">{% for line in source_lines %}
<div class="src-line" id="L{{ loop.index }}"><span class="ln">{{ "%4d"|format(loop.index) }}</span><span>{{ line | e }}</span></div>{% endfor %}</pre>
</div>

<script>
  // Preserve the original mermaid text so we can re-render highlights
  const ORIGINAL_MERMAID = `{{ mermaid_code | replace('`','\\`') | safe }}`;
  const NODEMAP = {{ node_map | tojson }};

  function setMermaid(text) {
    const el = document.getElementById('mermaidBox');
    el.innerHTML = '';
    el.classList.add('mermaid');
    el.textContent = text;

    // Mermaid is loaded in base.html; run re-render
    // mermaid.run accepts a list of nodes to render
    mermaid.run({ nodes: [el] });
  }

  function clearHighlights() {
    document.querySelectorAll('.src-line.hl').forEach(x => x.classList.remove('hl'));
  }

  function jumpToLineRange(start, end) {
    clearHighlights();
    if (!start) return;
    const s = Math.max(1, start);
    const e = Math.max(s, end || s);

    for (let i = s; i <= e; i++) {
      const row = document.getElementById('L' + i);
      if (row) row.classList.add('hl');
    }

    const target = document.getElementById('L' + s);
    if (target) target.scrollIntoView({ behavior: 'smooth', block: 'center' });
  }

  // Called by Mermaid click directives: `click Nxx onNodeClick "tooltip"`
  window.onNodeClick = function(nodeId) {
    const info = NODEMAP[nodeId];
    if (!info) return;
    jumpToLineRange(info.start_line, info.end_line);
  }

  // Search & highlight nodes by re-rendering Mermaid with a highlight class
  function applySearch(term) {
    const t = (term || '').trim().toLowerCase();
    if (!t) {
      setMermaid(ORIGINAL_MERMAID);
      return;
    }

    const matches = [];
    for (const [id, info] of Object.entries(NODEMAP)) {
      const hay = ((info.display || '') + ' ' + (info.name || '') + ' ' + (info.label || '')).toLowerCase();
      if (hay.includes(t)) matches.push(id);
    }

    const hl = [
      "classDef hl fill:#f59e0b,stroke:#fbbf24,color:#0b1220,stroke-width:2px;",
      matches.length ? `class ${matches.join(',')} hl;` : ""
    ].join("\n");

    setMermaid(ORIGINAL_MERMAID + "\n" + hl);
  }

  const searchBox = document.getElementById('nodeSearch');
  let searchTimer = null;
  searchBox.addEventListener('input', () => {
    clearTimeout(searchTimer);
    searchTimer = setTimeout(() => applySearch(searchBox.value), 180);
  });

  window.clearSearch = function() {
    searchBox.value = '';
    setMermaid(ORIGINAL_MERMAID);
  }

  // Export Mermaid source as .mmd
  window.exportMermaid = function() {
    const blob = new Blob([ORIGINAL_MERMAID], {type: 'text/plain;charset=utf-8'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `{{ filename }}.mmd`;
    a.click();
    URL.revokeObjectURL(a.href);
  }

  // Export rendered SVG
  window.exportSVG = function() {
    const svg = document.querySelector('.viz-container svg');
    if (!svg) {
      alert('SVG not ready yet. Scroll the graph once and try again.');
      return;
    }
    const serializer = new XMLSerializer();
    let src = serializer.serializeToString(svg);

    // Ensure xmlns is present
    if (!src.match(/^<svg[^>]+xmlns="http:\/\/www\.w3\.org\/2000\/svg"/)) {
      src = src.replace('<svg', '<svg xmlns="http://www.w3.org/2000/svg"');
    }
    if (!src.match(/^<svg[^>]+"http:\/\/www\.w3\.org\/1999\/xlink"/)) {
      src = src.replace('<svg', '<svg xmlns:xlink="http://www.w3.org/1999/xlink"');
    }

    const blob = new Blob([src], {type: 'image/svg+xml;charset=utf-8'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `{{ filename }}.svg`;
    a.click();
    URL.revokeObjectURL(a.href);
  }

  // Initial render: base.html already initializes Mermaid; ensure highlight rerenders work.
  // (No action needed; the initial HTML render will run automatically.)
</script>
{% endblock %}